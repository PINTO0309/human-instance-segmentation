# ROIサイズ分析レポート

## 概要

COCO train2017データセット（人物のみ、231,242個のROI）を分析し、最適なROIAlign出力サイズとモデルマスクサイズを提案します。

## データセット統計

### ROIサイズ分布

| 指標 | 幅（Width） | 高さ（Height） | 面積（Area） | アスペクト比 |
|------|-----------|--------------|------------|------------|
| 平均値 | 87.96 px | 143.34 px | 23,408 px² | 0.67 |
| 中央値 | 47.00 px | 90.00 px | 4,144 px² | 0.56 |
| 標準偏差 | 101.18 px | 134.52 px | 44,668 px² | 0.49 |
| 最小値 | 0.00 px | 1.00 px | 0 px² | 0.00 |
| 最大値 | 640.00 px | 640.00 px | 408,960 px² | 40.17 |
| 5パーセンタイル | 10.00 px | 17.00 px | 208 px² | 0.25 |
| 95パーセンタイル | 308.00 px | 425.00 px | 118,400 px² | 1.38 |

### 主な観察結果

1. **ROIサイズの多様性**: ROIのサイズは非常に多様で、最小10ピクセルから最大640ピクセルまで幅広く分布
2. **中央値と平均値の乖離**: 中央値が平均値より小さいことから、小さいROIが多数を占める一方、大きなROIが平均値を押し上げている
3. **アスペクト比**: 平均0.67（縦長の傾向）、人物の自然な形状を反映

## 品質評価基準

ROIAlign出力サイズによるダウンサンプリング率に基づいて品質を評価：

- **優秀な品質**: ダウンサンプリング率 ≤ 2倍（元の詳細をほぼ保持）
- **良好な品質**: ダウンサンプリング率 ≤ 4倍（重要な特徴を保持）
- **許容可能な品質**: ダウンサンプリング率 ≤ 8倍（基本的な形状を保持）

## 各設定での品質カバレッジ

| ROIAlign | マスク | 優秀(<2x) | 良好(<4x) | 許容(<8x) | 平均DS率 | 推奨度 |
|----------|--------|-----------|-----------|-----------|----------|--------|
| 14 | 28-224 | 13.2% | 34.1% | 55.5% | 10.63 | ✗ |
| **28** | **56** | **34.1%** | **55.5%** | **75.5%** | **5.32** | **現在** |
| 56 | 56-224 | 55.5% | 75.5% | 95.4% | 2.66 | ◯ |
| **112** | **112-224** | **75.5%** | **95.4%** | **100.0%** | **1.33** | **★推奨** |

## 推奨設定

### 最適な設定: ROIAlign=112, マスクサイズ=112

**推奨理由：**

1. **品質カバレッジの大幅改善**
   - 95.4%のROIで良好な品質（4倍以下のダウンサンプリング）を実現
   - 75.5%のROIで優秀な品質（2倍以下のダウンサンプリング）を実現
   - 現在の設定（28/56）と比較して、品質カバレッジが約40%向上

2. **精細なセグメンテーションに適した解像度**
   - 平均ダウンサンプリング率1.33倍は、ほとんどのROIで元の詳細を保持
   - 小さなROI（10-50ピクセル）でも十分な解像度を確保
   - 大きなROI（300-640ピクセル）でも過剰なアップサンプリングを回避

3. **計算効率とのバランス**
   - メモリ使用量: 約16倍増加（28×28→112×112）
   - 計算量: 約16倍増加
   - ただし、品質向上の効果がコストを上回る

### 代替案: ROIAlign=56, マスクサイズ=112

**中間的な選択肢として検討可能：**

- 75.5%のROIで良好な品質
- 55.5%のROIで優秀な品質
- 計算コスト: 現在の4倍（より現実的）
- 品質向上: 現在より約20%改善

## 実装への提言

### 1. 段階的な移行

```python
# Phase 1: 既存モデルとの互換性を保ちながらテスト
roi_size_options = [28, 56, 112]  # 複数サイズでの評価

# Phase 2: 最適サイズへの移行
optimal_roi_size = 112
optimal_mask_size = 112
```

### 2. 動的ROIサイズの検討

```python
def adaptive_roi_size(roi_width, roi_height):
    """ROIのサイズに応じて動的にROIAlignサイズを選択"""
    max_dim = max(roi_width, roi_height)
    if max_dim < 50:
        return 56  # 小さいROIには中程度の解像度
    elif max_dim < 200:
        return 112  # 中程度のROIには高解像度
    else:
        return 224  # 大きなROIには最高解像度
```

### 3. メモリ効率化の工夫

- バッチサイズの調整（112×112使用時は1/4に削減）
- Mixed precisionトレーニングの活用
- Gradient checkpointingの導入

## 結論

現在の設定（ROIAlign=28, マスク=56）は、計算効率を重視した設計ですが、精細なインスタンスセグメンテーションには解像度が不足しています。

**ROIAlign=112, マスクサイズ=112**への移行により：
- 95.4%のROIで良好な品質を実現
- 特に小〜中サイズのROI（全体の75%以上）で大幅な品質向上
- 境界の精度とセグメンテーション品質の向上が期待できる

計算コストは増加しますが、モデルの品質向上による恩恵が大きいため、この設定を強く推奨します。

## 追加の検討事項

1. **マルチスケール処理**: 異なるサイズのROIに対して異なる解像度を使用
2. **階層的処理**: 粗い解像度から始めて段階的に精緻化
3. **選択的高解像度**: 境界付近のみ高解像度で処理

これらの手法を組み合わせることで、計算効率と品質のさらなる最適化が可能です。